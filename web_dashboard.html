<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Price ML Pipeline - Real-Time Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: auto;
        }
        
        .status.healthy {
            background: #2ecc71;
            color: white;
        }
        
        .status.loading {
            background: #f39c12;
            color: white;
        }
        
        .status.error {
            background: #e74c3c;
            color: white;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: #7f8c8d;
            font-weight: 500;
        }
        
        .metric-value {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .positive {
            color: #27ae60 !important;
        }
        
        .negative {
            color: #e74c3c !important;
        }
        
        .signal {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .signal.buy {
            background: #2ecc71;
            color: white;
        }
        
        .signal.sell {
            background: #e74c3c;
            color: white;
        }
        
        .signal.hold {
            background: #f39c12;
            color: white;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }
        
        .loading {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 2rem;
        }
        
        .error {
            text-align: center;
            color: #e74c3c;
            padding: 2rem;
            background: #fdf2f2;
            border-radius: 10px;
            margin: 1rem 0;
        }
        
        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 1rem;
            transition: background 0.3s;
        }
        
        .refresh-btn:hover {
            background: #2980b9;
        }
        
        .websocket-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 1000;
        }
        
        .connected {
            background: #2ecc71;
            color: white;
        }
        
        .disconnected {
            background: #e74c3c;
            color: white;
        }
    </style>
</head>
<body>
    <div class="websocket-status" id="wsStatus">üî¥ Disconnected</div>
    
    <div class="header">
        <h1>üöÄ Stock Price ML Pipeline</h1>
        <p>Real-Time Portfolio Management with Machine Learning Predictions</p>
    </div>
    
    <div class="container">
        <!-- System Status -->
        <div class="grid">
            <div class="card">
                <h3>üè• System Health <span class="status loading" id="systemStatus">Loading...</span></h3>
                <div id="healthMetrics" class="loading">Checking system status...</div>
            </div>
            
            <div class="card">
                <h3>üìä Portfolio Overview</h3>
                <div id="portfolioMetrics" class="loading">Loading portfolio data...</div>
            </div>
        </div>
        
        <!-- Real-Time Market Data -->
        <div class="grid">
            <div class="card">
                <h3>üìà Real-Time Prices</h3>
                <div id="marketData" class="loading">Loading market data...</div>
                <button class="refresh-btn" onclick="loadMarketData()">Refresh Data</button>
            </div>
            
            <div class="card">
                <h3>üéØ Trading Signals</h3>
                <div id="tradingSignals" class="loading">Loading trading signals...</div>
                <button class="refresh-btn" onclick="loadTradingSignals()">Refresh Signals</button>
            </div>
        </div>
        
        <!-- Portfolio Optimization -->
        <div class="grid">
            <div class="card">
                <h3>‚öñÔ∏è Portfolio Optimization</h3>
                <div id="portfolioOptimization" class="loading">Loading optimization...</div>
                <div class="chart-container">
                    <canvas id="allocationChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h3>üìä Performance Metrics</h3>
                <div id="performanceMetrics" class="loading">Loading performance data...</div>
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001';
        let websocket = null;
        let allocationChart = null;
        let performanceChart = null;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadSystemHealth();
            loadMarketData();
            loadTradingSignals();
            loadPortfolioOptimization();
            initWebSocket();
            
            // Auto-refresh every 30 seconds
            setInterval(() => {
                loadSystemHealth();
                loadMarketData();
                loadTradingSignals();
            }, 30000);
        });
        
        // System Health
        async function loadSystemHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                document.getElementById('systemStatus').textContent = data.status.toUpperCase();
                document.getElementById('systemStatus').className = `status ${data.status}`;
                
                const healthHTML = `
                    <div class="metric">
                        <span class="metric-label">Redis Status</span>
                        <span class="metric-value">${data.services.redis}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Models Loaded</span>
                        <span class="metric-value">${Object.keys(data.services.models).length}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Active WebSockets</span>
                        <span class="metric-value">${data.services.active_websockets}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Features Available</span>
                        <span class="metric-value">${data.features.length}</span>
                    </div>
                `;
                
                document.getElementById('healthMetrics').innerHTML = healthHTML;
                
            } catch (error) {
                document.getElementById('systemStatus').textContent = 'ERROR';
                document.getElementById('systemStatus').className = 'status error';
                document.getElementById('healthMetrics').innerHTML = '<div class="error">Failed to load system health</div>';
            }
        }
        
        // Market Data
        async function loadMarketData() {
            const symbols = ['AAPL', 'GOOGL', 'MSFT', 'TSLA', 'AMZN'];
            let marketHTML = '';
            
            for (const symbol of symbols) {
                try {
                    const response = await fetch(`${API_BASE}/market/realtime/${symbol}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        const market = data.market_data;
                        const changeClass = market.change_pct >= 0 ? 'positive' : 'negative';
                        const changeSign = market.change_pct >= 0 ? '+' : '';
                        
                        marketHTML += `
                            <div class="metric">
                                <span class="metric-label">${symbol}</span>
                                <span class="metric-value">
                                    $${market.price.toFixed(2)} 
                                    <span class="${changeClass}">(${changeSign}${market.change_pct.toFixed(2)}%)</span>
                                </span>
                            </div>
                        `;
                    } else {
                        marketHTML += `
                            <div class="metric">
                                <span class="metric-label">${symbol}</span>
                                <span class="metric-value">No data</span>
                            </div>
                        `;
                    }
                } catch (error) {
                    marketHTML += `
                        <div class="metric">
                            <span class="metric-label">${symbol}</span>
                            <span class="metric-value">Error</span>
                        </div>
                    `;
                }
            }
            
            document.getElementById('marketData').innerHTML = marketHTML || '<div class="error">No market data available</div>';
        }
        
        // Trading Signals
        async function loadTradingSignals() {
            try {
                const response = await fetch(`${API_BASE}/trading/signals`);
                const data = await response.json();
                
                let signalsHTML = '';
                
                if (data.signals && data.signals.length > 0) {
                    data.signals.forEach(signal => {
                        const confidencePercent = (signal.confidence * 100).toFixed(0);
                        signalsHTML += `
                            <div class="metric">
                                <span class="metric-label">${signal.symbol}</span>
                                <span class="metric-value">
                                    <span class="signal ${signal.signal.toLowerCase()}">${signal.signal}</span>
                                    ${confidencePercent}%
                                </span>
                            </div>
                        `;
                    });
                } else {
                    signalsHTML = '<div class="loading">No trading signals available</div>';
                }
                
                document.getElementById('tradingSignals').innerHTML = signalsHTML;
                
            } catch (error) {
                document.getElementById('tradingSignals').innerHTML = '<div class="error">Failed to load trading signals</div>';
            }
        }
        
        // Portfolio Optimization
        async function loadPortfolioOptimization() {
            try {
                const response = await fetch(`${API_BASE}/portfolio/optimize`);
                const data = await response.json();
                
                if (data.optimization_successful) {
                    const weights = data.optimal_weights;
                    const metrics = data.expected_metrics;
                    
                    let optimizationHTML = `
                        <div class="metric">
                            <span class="metric-label">Expected Return</span>
                            <span class="metric-value positive">${(metrics.expected_return * 100).toFixed(1)}%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Volatility</span>
                            <span class="metric-value">${(metrics.volatility * 100).toFixed(1)}%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Sharpe Ratio</span>
                            <span class="metric-value positive">${metrics.sharpe_ratio.toFixed(2)}</span>
                        </div>
                    `;
                    
                    document.getElementById('portfolioOptimization').innerHTML = optimizationHTML;
                    
                    // Create allocation chart
                    createAllocationChart(weights);
                    
                } else {
                    document.getElementById('portfolioOptimization').innerHTML = '<div class="error">Portfolio optimization failed</div>';
                }
                
            } catch (error) {
                document.getElementById('portfolioOptimization').innerHTML = '<div class="error">Failed to load portfolio optimization</div>';
            }
        }
        
        // Create allocation pie chart
        function createAllocationChart(weights) {
            const ctx = document.getElementById('allocationChart').getContext('2d');
            
            if (allocationChart) {
                allocationChart.destroy();
            }
            
            allocationChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(weights),
                    datasets: [{
                        data: Object.values(weights).map(w => w * 100),
                        backgroundColor: [
                            '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // WebSocket Connection
        function initWebSocket() {
            try {
                websocket = new WebSocket('ws://localhost:8001/ws/realtime');
                
                websocket.onopen = function() {
                    document.getElementById('wsStatus').textContent = 'üü¢ Connected';
                    document.getElementById('wsStatus').className = 'websocket-status connected';
                };
                
                websocket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'market_update') {
                        updateRealTimeData(data.data);
                    }
                };
                
                websocket.onclose = function() {
                    document.getElementById('wsStatus').textContent = 'üî¥ Disconnected';
                    document.getElementById('wsStatus').className = 'websocket-status disconnected';
                    
                    // Reconnect after 5 seconds
                    setTimeout(initWebSocket, 5000);
                };
                
                websocket.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    document.getElementById('wsStatus').textContent = 'üî¥ Error';
                    document.getElementById('wsStatus').className = 'websocket-status disconnected';
                };
                
            } catch (error) {
                console.error('WebSocket connection failed:', error);
                document.getElementById('wsStatus').textContent = 'üî¥ Failed';
                document.getElementById('wsStatus').className = 'websocket-status disconnected';
            }
        }
        
        // Update real-time data from WebSocket
        function updateRealTimeData(marketData) {
            let marketHTML = '';
            
            Object.entries(marketData).forEach(([symbol, data]) => {
                const changeClass = data.change_pct >= 0 ? 'positive' : 'negative';
                const changeSign = data.change_pct >= 0 ? '+' : '';
                
                marketHTML += `
                    <div class="metric">
                        <span class="metric-label">${symbol}</span>
                        <span class="metric-value">
                            $${data.price.toFixed(2)} 
                            <span class="${changeClass}">(${changeSign}${data.change_pct.toFixed(2)}%)</span>
                            ${data.prediction ? `‚Üí $${data.prediction.toFixed(2)}` : ''}
                        </span>
                    </div>
                `;
            });
            
            document.getElementById('marketData').innerHTML = marketHTML;
        }
    </script>
</body>
</html>